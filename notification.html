<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ä¼šè­°é€šçŸ¥ãƒ„ãƒ¼ãƒ« v2.7</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; margin: 10px 40px; width: calc(100% - 80px); table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; overflow: hidden; white-space: nowrap; }
    th { background-color: #f0f0f0; }
    ul { margin-left: 40px; }
    .success { color: green; }
    .failure { color: red; }
    details { margin-top: 20px; }
    .boxWithTitle {
      position: relative;
      margin: 2em 0;
      padding: 1em;
      border: solid 2px #95ccff;
      border-radius: 8px;
      background: #f9f9ff;
    }
    .boxWithTitle .box-title {
      position: absolute;
      top: -13px;
      left: 15px;
      padding: 0 10px;
      font-size: 16px;
      background: #fff;
      color: #95ccff;
      font-weight: bold;
    }
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 6px;
      opacity: 0;
      transition: opacity 0.5s;
      z-index: 9999;
    }
    #meetingTable td:nth-child(1) { width: 240px; }
    #meetingTable td:nth-child(2) { width: 100px; text-align: center; }
    #meetingTable td:nth-child(3) { width: 80px; text-align: center; }
    #meetingTable td:nth-child(4) { width: 80px; text-align: center; }
    #meetingTable td:nth-child(5) { width: 100px; text-align: center; }
    #meetingTable td:nth-child(6) { width: 120px; text-align: center; }
  </style>
</head>
<body>
  <h1>ä¼šè­°é€šçŸ¥ãƒ„ãƒ¼ãƒ« v2.7 <span id="clockDisplay"></span></h1>
  <div id="toast"></div>

  <div class="boxWithTitle" id="inputArea">
    <span class="box-title">ä¼šè­°ç™»éŒ²ã¨å…¥åŠ›æ–¹å¼</span>
    <button onclick="switchMode('text')">ä¸€æ‹¬ç™»éŒ²ã«ä¾¿åˆ©ï¼ˆCSVé¢¨ï¼‰</button>
    <button onclick="switchMode('form')">1ä»¶ãšã¤ä¸å¯§ã«ç™»éŒ²</button>
    <p>å…¥åŠ›æ–¹å¼ã¯ã„ã¤ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã§ã™ã€‚ä¿å­˜å†…å®¹ã¯å…±é€šã§ã™ã€‚</p>
    <div id="inputFields"></div>
  </div>

  <div class="boxWithTitle" id="settingsArea">
    <span class="box-title">é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°</span>
    <label><input type="checkbox" value="15">15åˆ†å‰</label>
    <label><input type="checkbox" value="10">10åˆ†å‰</label>
    <label><input type="checkbox" value="5">5åˆ†å‰</label>
    <label><input type="checkbox" value="3" checked>3åˆ†å‰</label>
    <label><input type="checkbox" value="1">1åˆ†å‰</label>
  </div>

  <div class="boxWithTitle">
    <span class="box-title">URLèµ·å‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°</span>
    <label><input type="radio" name="launch" value="15">15åˆ†å‰</label>
    <label><input type="radio" name="launch" value="10">10åˆ†å‰</label>
    <label><input type="radio" name="launch" value="5">5åˆ†å‰</label>
    <label><input type="radio" name="launch" value="3" checked>3åˆ†å‰</label>
    <label><input type="radio" name="launch" value="1">1åˆ†å‰</label>
    <label><input type="radio" name="launch" value="0">é–‹å§‹æ™‚</label>
    <p style="margin-top:10px;">é€šçŸ¥ã¯è¤‡æ•°å›å±Šãã¾ã™ã€‚URLã¯1å›ã ã‘è‡ªå‹•èµ·å‹•ã•ã‚Œã¾ã™ã€‚</p>
  </div>

    <div class="boxWithTitle">
    <span class="box-title">ç™»éŒ²æ¸ˆã¿ä¼šè­°ä¸€è¦§</span>
    <table id="meetingTable">
      <thead>
        <tr>
          <th>ã‚¿ã‚¤ãƒˆãƒ«</th><th>æ›œæ—¥</th><th>æ™‚åˆ»</th><th>URL</th><th>æ“ä½œ</th><th>èµ·å‹•ã¾ã§ã®æ™‚é–“</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="boxWithTitle">
    <span class="box-title">æœ¬æ—¥ã®é€šçŸ¥å±¥æ­´</span>
    <details open>
      <summary>ä»Šæ—¥ã®å±¥æ­´</summary>
      <ul id="todayHistoryList"></ul>
    </details>
  </div>

  <div id="tutorialModal">
    <div id="tutorialContent">
      <p id="tutorialText"></p>
      <button onclick="nextTutorial()">æ¬¡ã¸</button>
    </div>
  </div>

  <script>
    const tutorialSteps = [
      "ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ä¼šè­°ã®é€šçŸ¥ã¨URLèµ·å‹•ã‚’è‡ªå‹•åŒ–ã™ã‚‹æ”¯æ´ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚",
      "é€šçŸ¥ã‚’è¨±å¯ã™ã‚‹ã¨ã€è¨­å®šã—ãŸæ™‚é–“ã«ä¼šè­°ã®é–‹å§‹ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚",
      "ä¼šè­°æƒ…å ±ã‚’å…¥åŠ›ã—ã€ä¿å­˜ã™ã‚‹ã¨é€šçŸ¥ã¨èµ·å‹•ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚",
      "é€šçŸ¥ã¯è¤‡æ•°å›å±Šãã¾ã™ãŒã€URLèµ·å‹•ã¯1å›ã®ã¿ã§ã™ã€‚æ··åŒã—ãªã„ã‚ˆã†ã”æ³¨æ„ãã ã•ã„ã€‚",
      "æº–å‚™ãŒã§ããŸã‚‰ã€ç”»é¢å³ä¸Šã®å…¥åŠ›æ–¹å¼ã‚’é¸ã‚“ã§å§‹ã‚ã¾ã—ã‚‡ã†ã€‚"
    ];
    let tutorialStep = 0;
    document.getElementById("tutorialText").textContent = tutorialSteps[tutorialStep];
    function nextTutorial() {
      tutorialStep++;
      if (tutorialStep < tutorialSteps.length) {
        document.getElementById("tutorialText").textContent = tutorialSteps[tutorialStep];
      } else {
        document.getElementById("tutorialModal").style.display = "none";
        localStorage.setItem("tutorialShown", "true");
      }
    }
    if (localStorage.getItem("tutorialShown")) {
      document.getElementById("tutorialModal").style.display = "none";
    }

    function updateClock() {
      const now = new Date();
      const days = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const str = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,"0")}æœˆ${String(now.getDate()).padStart(2,"0")}æ—¥(${days[now.getDay()]}) ${now.toLocaleTimeString()}`;
      document.getElementById("clockDisplay").textContent = str;
    }
    setInterval(updateClock, 1000);
    updateClock();

    let editingIndex = null;
    const launchHistory = new Set();

      function switchMode(mode, meeting = null, index = null) {
      const area = document.getElementById("inputFields");
      area.innerHTML = "";
      editingIndex = index;

      if (mode === "text") {
        const saved = JSON.parse(localStorage.getItem("meetings") || "[]");
        const csv = saved.map(m => `${m.title},${m.day},${m.time},${m.url}`).join("\n");
        area.innerHTML = `<textarea id="textInput" rows="5" cols="50" placeholder="ã‚¿ã‚¤ãƒˆãƒ«,æ›œæ—¥,æ™‚åˆ»,URL ã‚’æ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›">${csv}</textarea>
        <button onclick="saveText()">ä¿å­˜</button>`;
      } else {
        area.innerHTML = `
          <label>ã‚¿ã‚¤ãƒˆãƒ«<br><input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" value="${meeting?.title || ''}"></label><br>
          <label>æ›œæ—¥ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰<br>
            <label><input type="checkbox" name="day" value="æœˆ">æœˆ</label>
            <label><input type="checkbox" name="day" value="ç«">ç«</label>
            <label><input type="checkbox" name="day" value="æ°´">æ°´</label>
            <label><input type="checkbox" name="day" value="æœ¨">æœ¨</label>
            <label><input type="checkbox" name="day" value="é‡‘">é‡‘</label>
            <label><input type="checkbox" name="day" value="åœŸ">åœŸ</label>
            <label><input type="checkbox" name="day" value="æ—¥">æ—¥</label>
          </label><br>
          <label>æ™‚åˆ»<br><input id="time" type="time" value="${meeting?.time || ''}"></label><br>
          <label>URL<br><input id="url" placeholder="URL" style="width:600px" value="${meeting?.url || ''}"></label><br>
          <button onclick="saveForm()">ä¿å­˜</button>
        `;
      }
    }

    function saveText() {
      const lines = document.getElementById("textInput").value.trim().split("\n");
      const meetings = lines.map(line => {
        const [title, day, time, rawUrl] = line.split(",");
        let url = rawUrl.trim();
        if (!url.match(/^https?:\/\//)) {
          url = "https://" + url.replace(/^https?\/?\/?/, "");
        }
        return { title, day, time, url };
      });
      localStorage.setItem("meetings", JSON.stringify(meetings));
      renderSettings(meetings);
      scheduleAll(meetings);
    }

    function saveForm() {
      const dayCheckboxes = document.querySelectorAll('input[name="day"]:checked');
      const dayValues = Array.from(dayCheckboxes).map(cb => cb.value).join("/");

      let url = document.getElementById("url").value.trim();
      if (!url.match(/^https?:\/\//)) {
        url = "https://" + url.replace(/^https?\/?\/?/, "");
      }

      const meeting = {
        title: document.getElementById("title").value,
        day: dayValues,
        time: document.getElementById("time").value,
        url: url
      };

      const saved = JSON.parse(localStorage.getItem("meetings") || "[]");
      if (editingIndex !== null) {
        saved[editingIndex] = meeting;
        editingIndex = null;
      } else {
        saved.push(meeting);
      }

      localStorage.setItem("meetings", JSON.stringify(saved));
      renderSettings(saved);
      scheduleAll(saved);
    }

    function editMeeting(index) {
      const saved = JSON.parse(localStorage.getItem("meetings") || "[]");
      const meeting = saved[index];
      switchMode('form', meeting, index);
    }

    function deleteMeeting(index) {
      const saved = JSON.parse(localStorage.getItem("meetings") || "[]");
      saved.splice(index, 1);
      localStorage.setItem("meetings", JSON.stringify(saved));
      renderSettings(saved);
      scheduleAll(saved);
    }

    function truncateTitle(title) {
      const max = 20;
      return title.length > max ? title.slice(0, max) + "â€¦" : title;
    }

      function getRemainingTime(meetingTime, offsetMinutes) {
      const launchAt = new Date(meetingTime.getTime() - offsetMinutes * 60000);
      const now = new Date();
      const diff = launchAt - now;
      if (diff <= 0) return "çµ‚äº†";
      const mins = Math.floor(diff / 60000);
      const secs = Math.floor((diff % 60000) / 1000);
      return `æ®‹ã‚Š ${String(mins).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
    }

    function renderSettings(meetings) {
      const tbody = document.querySelector("#meetingTable tbody");
      tbody.innerHTML = "";
      const today = new Date();
      const weekdayMap = { "æ—¥": 0, "æœˆ": 1, "ç«": 2, "æ°´": 3, "æœ¨": 4, "é‡‘": 5, "åœŸ": 6 };
      const todayNum = today.getDay();
      const launchOffset = getLaunchTime();

      meetings.forEach((meeting, index) => {
        const tr = document.createElement("tr");
        const meetingDays = meeting.day.split("/").map(d => weekdayMap[d.trim()]);
        const [hour, minute] = meeting.time.split(":").map(Number);
        const meetingTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute);
        let timeInfo = "";

        if (meetingDays.includes(todayNum)) {
          timeInfo = getRemainingTime(meetingTime, launchOffset);
        }

        tr.innerHTML = `
          <td>${truncateTitle(meeting.title)}</td>
          <td>${meeting.day}</td>
          <td>${meeting.time}</td>
          <td><a href="${meeting.url}" target="_blank">ãƒªãƒ³ã‚¯</a></td>
          <td>
            <button onclick="editMeeting(${index})">âœï¸</button>
            <button onclick="deleteMeeting(${index})">ğŸ—‘ï¸</button>
          </td>
          <td>${timeInfo}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getNotifyTimes() {
      const checkboxes = document.querySelectorAll('#settingsArea input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => parseInt(cb.value));
    }

    function getLaunchTime() {
      const radio = document.querySelector('input[name="launch"]:checked');
      return radio ? parseInt(radio.value) : null;
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.opacity = 1;
      setTimeout(() => {
        toast.style.opacity = 0;
      }, 3000);
    }

    function scheduleAll(meetings) {
      const notifyTimes = getNotifyTimes();
      const launchTime = getLaunchTime();
      const today = new Date();
      const weekdayMap = { "æ—¥": 0, "æœˆ": 1, "ç«": 2, "æ°´": 3, "æœ¨": 4, "é‡‘": 5, "åœŸ": 6 };

      meetings.forEach(meeting => {
        const meetingDays = meeting.day.split("/").map(d => weekdayMap[d.trim()]);
        if (meetingDays.includes(today.getDay())) {
          const [hour, minute] = meeting.time.split(":").map(Number);
          const meetingTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute);

          notifyTimes.forEach(min => {
            const notifyAt = new Date(meetingTime.getTime() - min * 60000);
            if (notifyAt > new Date()) {
              setTimeout(() => {
                if (Notification.permission === "granted") {
                  new Notification(`${meeting.title} é–‹å§‹ã¾ã§ã‚ã¨${min}åˆ†`, { body: meeting.url });
                  logHistory(meeting, `é€šçŸ¥æˆåŠŸï¼ˆ${min}åˆ†å‰ï¼‰`);
                } else {
                  logHistory(meeting, `é€šçŸ¥å¤±æ•—ï¼ˆè¨±å¯ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ï¼‰`);
                  showToast(`${meeting.title} ã®é€šçŸ¥ã«å¤±æ•—ã—ã¾ã—ãŸ`);
                }
              }, notifyAt.getTime() - Date.now());
            }
          });

          const launchAt = new Date(meetingTime.getTime() - launchTime * 60000);
          const launchKey = `${launchAt.toISOString()}|${meeting.url}`;
          if (!launchHistory.has(launchKey) && launchAt > new Date()) {
            launchHistory.add(launchKey);
            setTimeout(() => {
              const win = window.open(meeting.url);
              const status = win ? "URLèµ·å‹•æˆåŠŸ" : "URLèµ·å‹•å¤±æ•—ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§ï¼‰";
              logHistory(meeting, status);
            }, launchAt.getTime() - Date.now());
          }
        }
      });
    }

    function logHistory(meeting, status) {
      const todayKey = new Date().toISOString().split("T")[0];
      const history = JSON.parse(localStorage.getItem("history") || "{}");
      history[todayKey] = history[todayKey] || [];
      history[todayKey].push({
        time: new Date().toLocaleTimeString(),
        title: meeting.title,
        url: meeting.url,
        status
      });
      localStorage.setItem("history", JSON.stringify(history));
      renderHistory(todayKey, history[todayKey]);
    }

    function renderHistory(dateKey, entries) {
      const list = document.getElementById("todayHistoryList");
      list.innerHTML = "";
      entries.forEach(item => {
        const li = document.createElement("li");
        li.className = item.status.includes("æˆåŠŸ") ? "success" : "failure";
        li.innerHTML = `${item.time} - ${item.title} (<a href="${item.url}" target="_blank" rel="noopener">${item.status}</a>)`;
        list.appendChild(li);
      });
    }

    // åˆæœŸåŒ–å‡¦ç†
    const savedMeetings = localStorage.getItem("meetings");
    if (savedMeetings) {
      const meetings = JSON.parse(savedMeetings);
      renderSettings(meetings);
      scheduleAll(meetings);
    }

    // å±¥æ­´åˆæœŸè¡¨ç¤ºï¼ˆæœ¬æ—¥åˆ†ï¼‰
    const todayKey = new Date().toISOString().split("T")[0];
    const history = JSON.parse(localStorage.getItem("history") || "{}");
    if (history[todayKey]) {
      renderHistory(todayKey, history[todayKey]);
    }

    // é€šçŸ¥è¨±å¯ã®ç¢ºèªã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          console.log("é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ");
        } else {
          console.warn("é€šçŸ¥ã¯æ‹’å¦ã•ã‚Œã¾ã—ãŸ");
        }
      });
    }

    // åˆæœŸè¡¨ç¤ºï¼šãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰
    switchMode('form');
  </script>
</body>
</html>
